You are a writing coach planning how to rewrite a piece of text with enhanced style.

## Your Task

Analyze the following text and create a paragraph-by-paragraph rewriting plan. For each paragraph, identify:
1. Its rhetorical function (what it's trying to do)
2. What craft move would enhance it
3. Tags to retrieve relevant examples from the catalog

## Target Style

{{ target_style_description }}

## Creative Latitude: {{ creative_latitude }}

{% if creative_latitude == "conservative" %}
Apply style conservatively. Preserve existing structure, enhance clarity and flow.
{% elif creative_latitude == "moderate" %}
Balance faithfulness with aesthetic improvement. Suggest craft moves that strengthen the argument without distorting intent.
{% else %}
Propose bold stylistic enhancements. Prioritize rhetorical excellence.
{% endif %}

## Available Craft Moves (Tags in Catalog)

The segment catalog contains examples with these tags:
{% for tag in available_tags[:30] %}
- {{ tag }}
{% endfor %}
{% if available_tags|length > 30 %}
... and {{ available_tags|length - 30 }} more
{% endif %}

**Important:** Only suggest craft moves that match available tags. Each paragraph should map to 1-4 tags.

## Text to Analyze

{{ flattened_text }}

## Instructions

1. **Break into paragraphs**: Identify natural paragraph boundaries
2. **Identify function**: What is each paragraph trying to accomplish?
3. **Assign craft move**: What technique would enhance this paragraph? Use tags from the catalog.
4. **Provide guidance**: Brief instruction on HOW to apply the craft move (2-3 sentences)

## Output Format

Return a JSON object with:
- `paragraphs`: Array of paragraph plans
- `overall_strategy`: High-level description of your rewriting approach
- `target_style`: Characteristics of the target style

Each paragraph plan should have:
- `paragraph_id`: Index (0, 1, 2...)
- `original_text`: The paragraph text
- `function`: Its rhetorical purpose
- `craft_move`: Primary technique to apply
- `craft_tags`: 1-4 tags for retrieving examples
- `guidance`: How to apply this craft move

**Example:**
```json
{
  "paragraphs": [
    {
      "paragraph_id": 0,
      "original_text": "Democracy has flaws. It can be inefficient.",
      "function": "Introduce topic with balanced acknowledgment",
      "craft_move": "concessive_opening",
      "craft_tags": ["concessive_opening", "balanced_judgment"],
      "guidance": "Open by granting ground to critics before pivoting. Establish fairness and objectivity."
    }
  ],
  "overall_strategy": "Rewrite as balanced philosophical exposition with concessive structure and rhythmic clarity",
  "target_style": "Balanced, lucid, rhythmically varied with Russellian concessions"
}
```

**Critical Rules:**
- Only use tags that exist in the available catalog
- Each paragraph should have 1-4 tags maximum
- Craft moves should be lowercase with underscores (e.g., "concessive_opening")
- Provide specific, actionable guidance
